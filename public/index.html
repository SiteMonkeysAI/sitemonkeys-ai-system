<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SiteMonkeys Business Validation Chat</title>
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    body {
      background: #1b1b1b;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: #111;
      border-bottom: 1px solid #333;
    }
    header img {
      height: 80px;
    }
    .main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .mascots {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 900px;
    }
    .mascots img {
      height: 150px;
    }
    .chat-container {
      width: 100%;
      max-width: 900px;
      background: #222;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    .chat-log {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }
    .message {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 70%;
    }
    .user {
      background: #2563eb;
      align-self: flex-end;
      text-align: right;
    }
    .ai {
      background: #2d2d2d;
      border: 1px solid #444;
      align-self: flex-start;
    }
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .controls input {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
    }
    .controls button {
      padding: 10px 15px;
      background: #ffc107;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .info-bar {
      font-size: 14px;
      margin-top: 10px;
      color: #bbb;
    }
    ul.file-list {
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="SiteMonkeys Logo">
    <h1>SiteMonkeys AI</h1>
  </header>

  <div class="main">
    <div class="mascots">
      <img src="boy-mascot.png" alt="Eli">
      <img src="girl-mascot.png" alt="Roxy">
    </div>

    <div class="chat-container">
      <div class="chat-log" id="chatLog"></div>

      <div class="controls">
        <input type="text" id="userInput" placeholder="Ask a business question...">
        <button onclick="sendMessage()">
          <img src="rocket-no-smoke.png" style="height: 24px;">
        </button>
      </div>
      <div class="info-bar" id="infoBar"></div>
    </div>
  </div>

  <script>
    let sessionVault = null;
    let sessionCost = 0;
    let messageCount = 0;

    async function initializeSession() {
      try {
        const res = await fetch('/api/load-vault');
        const data = await res.json();
        sessionVault = data.memory || '';
        const infoBar = document.getElementById('infoBar');
        infoBar.innerHTML = `‚úÖ Vault loaded | üìÑ Files: ${data.folders_loaded} | üî¢ Tokens: ${data.token_estimate} | üí∞ Estimated: ${data.estimated_cost}`;

        if (Array.isArray(data.file_debug)) {
          const fileNames = data.file_debug.filter(f => f.status === 'loaded').map(f => f.name);
          infoBar.innerHTML += `<br><strong>Loaded Files:</strong><ul class='file-list'><li>${fileNames.join('</li><li>')}</li></ul>`;
        }
      } catch (err) {
        document.getElementById('infoBar').textContent = '‚ùå Failed to load memory vault';
        console.error(err);
      }
    }

    async function sendMessage() {
      const input = document.getElementById('userInput');
      const text = input.value.trim();
      if (!text) return;

      appendMessage(`üßë You: ${text}`, 'user');
      input.value = '';

      const log = document.getElementById('chatLog');
      const thinking = document.createElement('div');
      thinking.className = 'message ai';
      thinking.textContent = 'üß† Thinking...';
      log.appendChild(thinking);

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, vault_memory: sessionVault })
        });
        const data = await res.json();
        thinking.remove();

        if (data?.response) {
          appendMessage(`üßí Eli: ${data.response}`, 'ai');
          sessionCost += parseFloat(data?.cost_info?.estimated_cost || 0);
          document.getElementById('infoBar').innerHTML += `<br>üí¨ Session total: $${sessionCost.toFixed(4)}`;
        } else {
          appendMessage(`‚ùå GPT returned no response.`, 'ai');
        }
      } catch (err) {
        thinking.textContent = '‚ùå Connection or processing error';
        console.error(err);
      }
    }

    function appendMessage(text, type) {
      const el = document.createElement('div');
      el.className = `message ${type}`;
      el.innerHTML = text.replace(/\n/g, '<br>');
      document.getElementById('chatLog').appendChild(el);
      document.getElementById('chatLog').scrollTop = document.getElementById('chatLog').scrollHeight;
    }

    window.addEventListener('load', initializeSession);
  </script>
</body>
</html>
