<script>
  // inside sendMessage()
  async function sendMessage() {
    const input = document.getElementById('userInput');
    const box = document.getElementById('chatBox');
    const msg = document.createElement('p');
    msg.textContent = '🧑 You: ' + input.value;
    box.appendChild(msg);
    sessionLog.push('🧑 You: ' + input.value);

    const thinking = document.createElement('p');
    thinking.textContent = '🐒 Sending to AI...';
    thinking.className = 'status';
    box.appendChild(thinking);
    box.scrollTop = box.scrollHeight;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: input.value, vault_memory: sessionVault })
      });
      const data = await res.json();
      thinking.remove();

      const label = messageCount % 2 === 0 ? '🧒 Eli:' : '👧 Roxy:';
      const response = document.createElement('p');
      response.className = 'status';
      response.innerHTML = `${label}<br>${data.response}`; // use .innerHTML to preserve <br> tags
      box.appendChild(response);
      sessionLog.push(`${label}\n${data.response.replace(/<br>/g, '\n')}`);

      if (data.cost_info?.estimated_cost) {
        sessionCost += parseFloat(data.cost_info.estimated_cost);
        const costNote = document.createElement('p');
        costNote.className = 'status';
        costNote.textContent = `💰 Session total: $${sessionCost.toFixed(4)} | Tokens: ${data.cost_info.total_tokens || 'N/A'}`;
        box.appendChild(costNote);
        sessionLog.push(costNote.textContent);
      }

      box.scrollTop = box.scrollHeight;
      messageCount++;
    } catch (err) {
      thinking.textContent = '❌ Connection error';
      console.error(err);
    }
    input.value = '';
  }
</script>
