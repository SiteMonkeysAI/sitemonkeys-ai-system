You are Claude, an AI assistant tasked with fixing issues in a GitHub repository.

Issue #174: [claude-fix] Memory System Test Harness + Mechanical Fixes

Issue Description:
### Overview

Memory system has mechanical failures. Before fixing, we need automated testing to verify fixes work and prevent regressions.

**Phase 1:** Build test harness + debug endpoint
**Phase 2:** Implement storage/dedup/retrieval fixes
**Phase 3:** Run harness to verify fixes

-----

## PHASE 1: TEST HARNESS

### 1A. Debug Endpoint

Create `/api/debug/memory` endpoint that returns memory operation details.

**File:** `/api/routes/debug.js` (or add to existing routes)

```javascript
// GET /api/debug/memory?user_id=xxx&action=last_operation
// Returns: { 
//   last_store: { memory_id, content_preview, category, dedup_triggered, dedup_merged_with },
//   last_retrieve: { memory_ids, query, category_searched, results_count },
//   last_inject: { memory_injected, memory_ids, token_count }
// }
```

**Security:** Only available when `DEPLOYMENT_TYPE=private` or `DEBUG_MODE=true`

### 1B. Test Harness Script

**File:** `/scripts/memory-regression-test.js`

```javascript
/**
 * Memory System Regression Tests
 * Run: npm run test:memory
 * 
 * Tests storage, dedup, retrieval, injection, and enforcer behavior
 */

const TEST_USER_ID = `test-user-${Date.now()}`;
const API_BASE = process.env.API_URL || 'http://localhost:3000';

const tests = [
  // === STORAGE TESTS ===
  {
    name: 'Store simple fact',
    action: 'chat',
    message: `Remember this: My favorite color is BLUE-WAVE-${Date.now()}`,
    expect: { stored: true, dedup_merged: false }
  },
  {
    name: 'Recall simple fact',
    action: 'chat', 
    message: 'What is my favorite color?',
    expect: { 
      memory_injected: true,
      response_contains: 'BLUE-WAVE',
      no_ignorance_phrases: true
    }
  },
  
  // === DEDUP TESTS ===
  {
    name: 'Store tripwire A',
    action: 'chat',
    message: `My verification code is ALPHA-TANGO-${Date.now()}`,
    expect: { stored: true, new_memory_id: true }
  },
  {
    name: 'Store tripwire B (different)',
    action: 'chat',
    message: `My backup phrase is ZEBRA-ANCHOR-${Date.now() + 1}`,
    expect: { stored: true, new_memory_id: true, not_merged_with_previous: true }
  },
  {
    name: 'Recall tripwire A specifically',
    action: 'chat',
    message: 'What is my verification code?',
    expect: { response_contains: 'ALPHA-TANGO', response_not_contains: 'ZEBRA-ANCHOR' }
  },
  
  // === BOILERPLATE REJECTION TESTS ===
  {
    name: 'AI boilerplate should not be stored',
    action: 'chat',
    message: 'Tell me about yourself',
    then_check: 'debug',
    expect: { 
      stored_content_not_contains: ["I don't retain memory", "session-based", "first interaction"]
    }
  },
  
  // === RETRIEVAL ROUTING TESTS ===
  {
    name: 'Store tech fact',
    action: 'chat',
    message: `My preferred IDE is VSCODE-CUSTOM-${Date.now()}`,
    expect: { stored: true, category_contains: 'tools_tech' }
  },
  {
    name: 'Store personal fact',
    action: 'chat',
    message: `My dog's name is ROVER-SPECIAL-${Date.now()}`,
    expect: { stored: true, category_contains: 'personal_life' }
  },
  {
    name: 'Retrieve tech fact routes correctly',
    action: 'chat',
    message: 'What IDE do I use?',
    expect: { memory_injected: true, category_searched: 'tools_tech' }
  },
  
  // === ENFORCER TESTS ===
  {
    name: 'Enforcer catches ignorance when memory present',
    action: 'chat',
    message: 'What is my favorite color?', // Already stored above
    expect: { 
      memory_injected: true,
      no_ignorance_phrases: true // Should NOT say "I don't have that information"
    }
  },
  
  // === CONSISTENCY TESTS ===
  {
    name: 'Recall consistency - attempt 1',
    action: 'chat',
    message: 'What is my backup phrase?',
    expect: { response_contains: 'ZEBRA-ANCHOR' }
  },
  {
    name: 'Recall consistency - attempt 2',
    action: 'chat',
    message: 'What is my backup phrase?',
    expect: { response_contains: 'ZEBRA-ANCHOR' }
  }
];

// Ignorance phrases that should trigger FAIL if memory was injected
const IGNORANCE_PHRASES = [
  "I don't have",
  "I don't see",
  "no memory of",
  "haven't told me",
  "don't have access",
  "no information about",
  "not aware of",
  "don't recall",
  "no record of",
  "first interaction",
  "haven't shared"
];

async function runTests() {
  console.log('═══════════════════════════════════════════');
  console.log('MEMORY SYSTEM REGRESSION TESTS');
  console.log(`Test User: ${TEST_USER_ID}`);
  console.log(`API: ${API_BASE}`);
  console.log('═══════════════════════════════════════════\n');
  
  let passed = 0;
  let failed = 0;
  const failures = [];
  
  for (const test of tests) {
    process.stdout.write(`Testing: ${test.name}... `);
    
    try {
      const result = await executeTest(test);
      
      if (result.passed) {
        console.log('✅ PASS');
        passed++;
      } else {
        console.log('❌ FAIL');
        console.log(`   Reason: ${result.reason}`);
        failed++;
        failures.push({ test: test.name, reason: result.reason, response: result.response });
      }
    } catch (err) {
      console.log('❌ ERROR');
      console.log(`   ${err.message}`);
      failed++;
      failures.push({ test: test.name, reason: err.message });
    }
  }
  
  console.log('\n═══════════════════════════════════════════');
  console.log('SUMMARY');
  console.log('═══════════════════════════════════════════');
  console.log(`Total:  ${tests.length}`);
  console.log(`Passed: ${passed} ✅`);
  console.log(`Failed: ${failed} ❌`);
  
  if (failures.length > 0) {
    console.log('\nFAILURES:');
    failures.forEach((f, i) => {
      console.log(`\n${i + 1}. ${f.test}`);
      console.log(`   Reason: ${f.reason}`);
      if (f.response) {
        console.log(`   Response preview: ${f.response.substring(0, 200)}...`);
      }
    });
  }
  
  process.exit(failed > 0 ? 1 : 0);
}

async function executeTest(test) {
  // Implementation details...
  // POST to /api/chat, GET from /api/debug/memory
  // Compare results against test.expect
}

runTests();
```

### 1C. Package.json Script

Add to `package.json`:

```json
{
  "scripts": {
    "test:memory": "node scripts/memory-regression-test.js"
  }
}
```

-----

## PHASE 2: MECHANICAL FIXES

*(Include all the fixes from the previous issue here)*

### 2A. Storage Filter

Before storing ANY memory, strip assistant/system boilerplate…

### 2B. Dedup Guards

Prevent dedup from merging unrelated items…

### 2C. Retrieval Upgrade

Add exact-match pass before LIKE search…

### 2D. Debug Logging

Add memory debug preview when injected…

### 2E. Sensitive Data Policy

Pick and enforce consistently…

-----

## PHASE 3: VERIFICATION

After implementing Phase 2 fixes:

1. Run `npm run test:memory`
1. All tests must PASS
1. If any FAIL, debug and fix before marking complete

-----

## Acceptance Criteria

- [ ] `/api/debug/memory` endpoint exists and returns operation details
- [ ] `npm run test:memory` runs 20+ tests
- [ ] Test harness captures pass/fail with reasons
- [ ] Storage filter rejects boilerplate
- [ ] Dedup guards prevent false merges
- [ ] Retrieval finds exact high-entropy tokens
- [ ] All regression tests PASS after fixes

-----

## Files to Create/Modify

**Create:**

- `/scripts/memory-regression-test.js`
- `/api/routes/debug.js` (or add to existing)

**Modify:**

- `package.json` (add test script)
- Storage pipeline (add sanitizer)
- Dedup logic (add guards)
- Retrieval logic (add exact match pass)

-----

## Constraints (from CLAUDE.md)

- Follow sacred order: RETRIEVE → INJECT → GENERATE → VALIDATE
- ES6 modules only
- Debug endpoint only available in private/debug mode
- Do not change response JSON schema
Your task is to:
1. Analyze the issue carefully to understand the problem
2. Look through the repository to identify the relevant files that need to be modified
3. Make precise changes to fix the issue
4. Use the Edit tool to modify files directly when needed
5. Be minimal in your changes - only modify what's necessary to fix the issue

After making changes, provide a summary of what you did in this format:

---SUMMARY---
[Your detailed summary of changes, including which files were modified and how]
---END SUMMARY---

Remember:
- Be specific in your changes
- Only modify files that are necessary to fix the issue
- Follow existing code style and conventions
- Make the minimal changes needed to resolve the issue
