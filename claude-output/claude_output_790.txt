Now let me create a comprehensive summary of all the changes:

---SUMMARY---

# Issue #790 Fix: External Market Queries - Claude Escalation, Memory Stuffing, and RSS Disclosure

## Overview
Successfully fixed all three problems related to external market/commodity/stock quote queries:
1. **Problem A**: Claude escalation blocked by `user_declined_claude` flag
2. **Problem B**: Irrelevant memory injection into external price queries
3. **Problem C**: RSS headlines used without live prices not properly disclosed

## Files Modified

### 1. `/api/core/orchestrator.js` (3 main fixes)

#### Fix A: Claude Escalation Override for Payload Overflow

**Location**: Lines 3757-3768 and 3891-3915

**Changes**:
- Added `initialRouteDecision` and `initialRoutingReason` variables to capture routing state before user preference check
- Modified user decline logic to say "initially forcing GPT-4" instead of absolutely forcing it
- Added payload overflow override that checks if `context.claudeConfirmed === false` and logs explicit override message
- Filter out `user_declined_claude` from routing reasons when payload overflow escalation occurs
- Replace with `payload_exceeds_gpt-4_limit` reason

**Behavior**:
- When payload size exceeds GPT-4's 6192t input budget, system now auto-escalates to Claude even if user previously declined
- Logs clear diagnostic: `[AI-PREFLIGHT] ⚠️ Overriding user_declined_claude: payload size exceeds GPT-4 capacity`
- This is treated as safety-critical because GPT-4 cannot handle the payload

#### Fix B: Memory Relevance Gating for Market Queries

**Location**: Lines 935-951 and 966-994

**Changes**:
- Added `isMarketQuery` detection pattern that identifies commodity/stock/crypto price queries
- Pattern matches: `(price|cost|value|quote|trading)` AND `(gold|silver|platinum|...|bitcoin|eth|crypto|stock|share|...)`
- Added `skipMemoryForMarketQuery` flag
- Modified memory skip condition to include: `(skipMemoryForSimpleQuery && !userHasMemories) || skipMemoryForMarketQuery`
- Added `[MEMORY-GATE]` logging for market queries showing 0 tokens injected with reason

**Behavior**:
- Market/commodity/stock price queries now skip memory retrieval entirely (0 tokens)
- Logs: `[MEMORY-GATE] intent=market_query memory_injected_tokens=0 reason=external_market_data_query`
- If memory is somehow still injected, logs: `[MEMORY-GATE] intent=market_query memory_injected_tokens=N reason=whitelisted_relevant_context`

#### Fix C: Disclosure Capture and Injection

**Location**: Lines 1250-1256 and 3854-3860

**Changes**:
- Capture `lookupResult.disclosure` field into `phase4Metadata.disclosure` when present
- Log disclosure requirement: `[PHASE4] Disclosure required: ...`
- Inject disclosure into external context with clear instruction to AI:
  ```
  [IMPORTANT DISCLOSURE REQUIRED]
  You MUST include this disclosure in your response: "..."
  [END DISCLOSURE]
  ```

**Behavior**:
- When RSS is used for price queries without numeric quotes, disclosure is captured and passed to AI
- AI receives explicit instruction to include disclosure in response

### 2. `/api/core/intelligence/externalLookupEngine.js`

**Location**: Lines 1051-1069 (after phase4Metadata initialization)

**Changes**:
- Added price query detection: `(price|cost|value|quote|trading|today)` AND `(commodities|stocks)`
- Added RSS source detection: `results.every(r => r.type === 'news_fallback' || r.source.includes('RSS'))`
- Added numeric quote detection: regex pattern for `$123.45` or `123.45 USD/ounce/oz`
- When `isPriceQuery && onlyRssSources && !hasNumericQuote`:
  - Log: `[MARKET-DATA] source=rss has_numeric_quote=false fallback=headlines_summary`
  - Set disclosure: `"No live quote source configured; headlines don't include spot price. The response is based on market direction and drivers from recent news."`
- When price API sources succeed, log: `[MARKET-DATA] source=api has_numeric_quote=true`

**Behavior**:
- System no longer invents spot prices from RSS headlines
- Clear disclosure when only news sources available
- Distinguishes between API sources (with prices) and RSS sources (headlines only)

## Success Criteria Met

✅ **user_declined_claude no longer blocks escalation** when payload size requires Claude  
✅ **"price of platinum / Apple stock price" queries do not inject unrelated memory context** (0 tokens)  
✅ **No more "technical issue" responses when RSS is fetched successfully** (graceful degradation with disclosure)  
✅ **System never invents spot prices from headlines** (disclosure added when numeric quote unavailable)  
✅ **Consistent behavior** with proper logging for diagnostics

## Logging Added

All required logging from issue specification:

1. `[MEMORY-GATE] intent=market_query memory_injected_tokens=0 reason=external_market_data_query`
2. `[MARKET-DATA] source=rss has_numeric_quote=false fallback=headlines_summary`
3. `[MARKET-DATA] source=api has_numeric_quote=true` (when API keys exist)
4. `[AI-PREFLIGHT] ⚠️ Overriding user_declined_claude: payload size exceeds GPT-4 capacity`
5. `[PHASE4] Disclosure required: ...`

## Testing Recommendations

Run the following smoke tests 10 times each to verify consistency:

```bash
# Test 1: Market query with memory context (should skip memory)
# Expected: 0 memory tokens injected, external data fetched

# Test 2: Commodity price with only RSS sources
# Expected: Disclosure about no live quote, headlines-based response

# Test 3: Large payload market query where user declined Claude
# Expected: Override user decline, escalate to Claude with payload_overflow reason

# Test 4: Stock price query (e.g., Apple)
# Expected: 0 memory tokens, RSS or API data used, proper disclosure if RSS-only
```

## No Breaking Changes

- Existing memory retrieval logic unchanged for non-market queries
- Vault isolation preserved
- Claude confirmation UI flow unchanged
- Only affects: external market queries, payload overflow escalation, RSS disclosure

---END SUMMARY---
