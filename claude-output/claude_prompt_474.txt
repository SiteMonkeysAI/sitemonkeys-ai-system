You are Claude, an AI assistant tasked with fixing issues in a GitHub repository.

Issue #474: [claude-fix] Fix db-migration schema replication to use SERIAL instead of sequence references

Issue Description:
# Fix db-migration schema replication to use SERIAL instead of sequence references

## Issue Type
**Infrastructure Bug Fix** - One-time migration code modification

## Priority
**CRITICAL** - Blocking database migration to pgvector-enabled PostgreSQL

## Context
The pgvector migration infrastructure (PR #471) is deployed and working, but schema replication fails because it copies `DEFAULT nextval('sequence_name')` references from the source database. These sequences don't exist in the target database, causing creation failures.

**Current Error:**
```
relation "persistent_memories_id_seq" does not exist
relation "memory_categories_id_seq" does not exist
relation "documents_id_seq" does not exist
relation "document_chunks_id_seq" does not exist
```

**Tables affected:** 4 of 5 tables fail (only `user_memory_profiles` succeeds because it uses `text` primary key, not auto-increment)

---

## ROOT CAUSE ANALYSIS

In `api/admin/db-migration.js`, the `getTableSchema()` function (lines 130-150) queries the PostgreSQL catalog to get column definitions:

```javascript
const query = `
  SELECT 
    a.attname AS column_name,
    format_type(a.atttypid, a.atttypmod) AS data_type,
    a.attnotnull AS not_null,
    pg_get_expr(d.adbin, d.adrelid) AS default_value,
    a.attnum AS ordinal_position
  FROM pg_attribute a
  LEFT JOIN pg_attrdef d ON a.attrelid = d.adrelid AND a.attnum = d.adnum
  WHERE a.attrelid = $1::regclass
    AND a.attnum > 0
    AND NOT a.attisdropped
  ORDER BY a.attnum
`;
```

The `pg_get_expr(d.adbin, d.adrelid)` returns the DEFAULT expression verbatim, which includes sequence references like:
```sql
nextval('persistent_memories_id_seq'::regclass)
```

When this is used to build the CREATE TABLE statement in `replicateSchema()` (lines 230-280), it generates:
```sql
CREATE TABLE IF NOT EXISTS "persistent_memories" (
  "id" integer NOT NULL DEFAULT nextval('persistent_memories_id_seq'::regclass),
  ...
)
```

This fails because `persistent_memories_id_seq` doesn't exist in the new database.

---

## REQUIRED FIX

**File:** `api/admin/db-migration.js`

**Location:** The `replicateSchema()` function, specifically where it builds the column definitions (around line 250-265)

### Fix Strategy

When building the CREATE TABLE statement, detect if a column is an auto-increment integer primary key and replace the `nextval()` default with `SERIAL` type (or `BIGSERIAL` for bigint).

### Specific Changes Required

**1. Add a helper function to detect and handle auto-increment columns:**

```javascript
/**
 * Converts nextval() defaults to SERIAL/BIGSERIAL types
 * @param {string} dataType - The column's data type (e.g., 'integer', 'bigint')
 * @param {string|null} defaultValue - The DEFAULT expression
 * @param {string} columnName - The column name
 * @param {string} pkColumn - The table's primary key column name
 * @returns {Object} { newDataType, newDefault } - Adjusted type and default
 */
function handleAutoIncrement(dataType, defaultValue, columnName, pkColumn) {
  // Check if this is an auto-increment column (has nextval default)
  const isAutoIncrement = defaultValue && 
    defaultValue.toLowerCase().includes('nextval(') &&
    defaultValue.toLowerCase().includes('_seq');
  
  if (!isAutoIncrement) {
    return { newDataType: dataType, newDefault: defaultValue };
  }
  
  // Convert to SERIAL or BIGSERIAL based on original type
  if (dataType === 'integer') {
    return { newDataType: 'SERIAL', newDefault: null };
  } else if (dataType === 'bigint') {
    return { newDataType: 'BIGSERIAL', newDefault: null };
  } else if (dataType === 'smallint') {
    return { newDataType: 'SMALLSERIAL', newDefault: null };
  }
  
  // For other types with nextval, strip the default (will fail gracefully)
  console.log(`[DB-MIGRATION] Warning: Unexpected auto-increment type ${dataType} for column ${columnName}`);
  return { newDataType: dataType, newDefault: null };
}
```

**2. Modify the column definition building loop in `replicateSchema()` (around line 250):**

**BEFORE:**
```javascript
const columns = schema.map(col => {
  let def = `"${col.column_name}" ${col.data_type}`;
  
  if (col.not_null) {
    def += ' NOT NULL';
  }
  
  if (col.default_value) {
    def += ` DEFAULT ${col.default_value}`;
  }
  
  return def;
}).join(',\n  ');
```

**AFTER:**
```javascript
const columns = schema.map(col => {
  // Handle auto-increment columns (convert nextval to SERIAL)
  const { newDataType, newDefault } = handleAutoIncrement(
    col.data_type,
    col.default_value,
    col.column_name,
    pkInfo.column
  );
  
  let def = `"${col.column_name}" ${newDataType}`;
  
  // SERIAL types implicitly include NOT NULL, so skip for auto-increment
  const isSerial = ['SERIAL', 'BIGSERIAL', 'SMALLSERIAL'].includes(newDataType);
  
  if (col.not_null && !isSerial) {
    def += ' NOT NULL';
  }
  
  if (newDefault) {
    def += ` DEFAULT ${newDefault}`;
  }
  
  return def;
}).join(',\n  ');
```

**3. Adjust PRIMARY KEY handling for SERIAL columns:**

When using SERIAL types, the PRIMARY KEY constraint should still be added separately (SERIAL doesn't automatically make it a primary key). The existing code already handles this correctly by adding the PRIMARY KEY constraint at the end, so no change needed there.

**4. Add logging for transparency:**

Add a log statement when auto-increment conversion happens:
```javascript
if (isAutoIncrement) {
  console.log(`[DB-MIGRATION] Converting ${col.column_name} from ${dataType} with nextval() to ${newDataType}`);
}
```

---

## EXPECTED BEHAVIOR AFTER FIX

**Generated SQL should change from:**
```sql
CREATE TABLE IF NOT EXISTS "persistent_memories" (
  "id" integer NOT NULL DEFAULT nextval('persistent_memories_id_seq'::regclass),
  "user_id" text NOT NULL,
  ...
  PRIMARY KEY ("id")
)
```

**To:**
```sql
CREATE TABLE IF NOT EXISTS "persistent_memories" (
  "id" SERIAL,
  "user_id" text NOT NULL,
  ...
  PRIMARY KEY ("id")
)
```

---

## ACCEPTANCE CRITERIA

1. **All 5 tables create successfully** in the new pgvector database
2. **Auto-increment columns work correctly** - new rows get sequential IDs
3. **No sequence reference errors** - no "relation does not exist" errors
4. **Existing data migrates correctly** - data migration phase should work unchanged
5. **Logging shows conversion** - `[DB-MIGRATION] Converting id from integer with nextval() to SERIAL`

---

## VERIFICATION STEPS

After deploying the fix:

1. **Test schema creation (dry run):**
```javascript
fetch('https://sitemonkeys-ai-system-production.up.railway.app/api/admin/db-schema?dryRun=true', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Migration-Secret': 'migrate-jan2026-secure'
  }
}).then(r => r.json()).then(console.log)
```

Verify SQL shows `SERIAL` instead of `nextval()`.

2. **Execute schema creation:**
```javascript
fetch('https://sitemonkeys-ai-system-production.up.railway.app/api/admin/db-schema', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Migration-Secret': 'migrate-jan2026-secure'
  }
}).then(r => r.json()).then(console.log)
```

Verify all 5 tables show `success: true`.

3. **Verify tables exist:**
```javascript
fetch('https://sitemonkeys-ai-system-production.up.railway.app/api/admin/db-tables', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-Migration-Secret': 'migrate-jan2026-secure'
  }
}).then(r => r.json()).then(console.log)
```

Verify `existsInNewDB: true` for all 5 tables.

---

## DOCTRINE ALIGNMENT

### Technical Standards Compliance
- **ES6 Modules:** All code uses `import`/`export` ✓
- **Async/Await:** Existing pattern maintained ✓
- **Error Handling:** Existing try/catch structure preserved ✓
- **Naming:** camelCase functions, descriptive names ✓
- **Comments:** JSDoc for new helper function ✓

### Code Standards (from TECHNICAL_STANDARDS)
- **Parameterized queries:** No SQL injection risk (table names already validated)
- **Structured returns:** Existing return format preserved
- **Logging:** Uses `[DB-MIGRATION]` prefix for consistency

### Master Specification Compliance
- **Database:** PostgreSQL operations through proper patterns
- **No new files:** Modification only to existing `api/admin/db-migration.js`
- **Temporary code:** This is one-time migration code (will be deleted after migration)

---

## FILES TO MODIFY

**ONLY ONE FILE:**
- `api/admin/db-migration.js` (approximately lines 130-280)

**NO NEW FILES SHOULD BE CREATED.**

---

## CONSTRAINTS

1. **Do NOT change the endpoint paths** - `/api/admin/db-schema` must remain unchanged
2. **Do NOT change the authentication** - secret validation must remain unchanged
3. **Do NOT change the dry-run logic** - existing dryRun parameter handling must remain
4. **Preserve all existing functionality** - only enhance the column definition generation
5. **ES6 modules only** - no `require()` or `module.exports`

---

## NOTES FOR IMPLEMENTATION

- The `handleAutoIncrement()` helper function should be added near the top of the file with other helper functions (around line 30-100)
- The modification to the column loop is minimal and surgical
- SERIAL in PostgreSQL automatically creates the sequence and sets up the default - we don't need to manually create sequences
- The fix is backwards-compatible - tables without auto-increment columns are unaffected
- This code will be **deleted after successful migration** per the original design

---

## RELATED

- **PR #471:** Original migration infrastructure implementation
- **Issue #468:** pgvector Infrastructure Migration requirement
- **Blocking:** Complete database migration to pgvector-enabled PostgreSQL
Your task is to:
1. Analyze the issue carefully to understand the problem
2. Look through the repository to identify the relevant files that need to be modified
3. Make precise changes to fix the issue
4. Use the Edit tool to modify files directly when needed
5. Be minimal in your changes - only modify what's necessary to fix the issue

After making changes, provide a summary of what you did in this format:

---SUMMARY---
[Your detailed summary of changes, including which files were modified and how]
---END SUMMARY---

Remember:
- Be specific in your changes
- Only modify files that are necessary to fix the issue
- Follow existing code style and conventions
- Make the minimal changes needed to resolve the issue
