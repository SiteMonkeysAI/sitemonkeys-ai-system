Now let me create a summary of what was done:

---SUMMARY---

## Fixed Issue #555: T2 Token Extraction and T3 Semantic Ranking Issues

### Changes Made to `/home/runner/work/sitemonkeys-ai-system/sitemonkeys-ai-system/api/services/semantic-retrieval.js`

### Fix 1: T2 - Token Extraction Pattern (Lines 857-858)

**Problem**: The token extraction pattern in the embedding fallback code was too restrictive. It required either 3 segments (X-X-X) or the pattern LETTERS-NUMBERS, which didn't match 2-segment tokens like `ZEBRA-ANCHOR-123`.

**Root Cause**: Line 790 had the pattern:
```javascript
const uniqueTokens = safeQuery.match(/[A-Z0-9]{1,20}-[A-Z0-9]{1,20}-[A-Z0-9]{1,20}|[A-Z]{4,20}-[0-9]{1,20}/gi);
```

This pattern was inconsistent with the recent unembedded memory scoring pattern at line 950, which correctly used:
```javascript
const uniqueTokenPattern = /\b[A-Z0-9]{3,}(?:-[A-Z0-9]{2,})+\b/gi;
```

**Solution**: Updated the fallback token extraction pattern to match 2+ segment tokens:
```javascript
// FIX #555-T2: Updated pattern to match 2+ segment tokens like ZEBRA-ANCHOR-123
const uniqueTokens = safeQuery.match(/\b[A-Z0-9]{3,20}(?:-[A-Z0-9]{2,20})+\b/gi);
```

This pattern now matches:
- `ZEBRA-ANCHOR-123` (2 segments)
- `ALPHA-TANGO-456` (2 segments)
- `ABC-DEF-GHI-789` (3+ segments)
- Any alphanumeric token with 2 or more segments separated by hyphens

### Fix 2: T3 - Ordinal-Aware Semantic Ranking (Lines 160-225, 1095-1097)

**Problem**: Queries like "What is my first code?" and "What is my second code?" produced semantically almost identical embeddings, causing the wrong memory to be retrieved due to tie-breaking (recency, alphabetical, or random).

**Root Cause**: Pure semantic similarity cannot distinguish between "My first code is CHARLIE" and "My second code is DELTA" when the query only differs by the ordinal word ("first" vs "second").

**Solution**: Implemented an ordinal-aware boosting system that detects ordinal indicators in queries and boosts memories containing the same ordinal.

**New Function Added** (`applyOrdinalBoost` at lines 169-225):
- Detects ordinal patterns: first, second, third, fourth, fifth, last, previous, next (including numeric variants like 1st, 2nd, etc.)
- When a query contains an ordinal (e.g., "first"), it boosts the similarity score by 0.25 for memories that also contain that same ordinal
- Applied in the retrieval pipeline between safety-critical boost and hybrid scoring (line 1097)

**Example**:
- Query: "What is my first code?"
- Memory 1: "My first code is CHARLIE" - Gets +0.25 boost
- Memory 2: "My second code is DELTA" - No boost
- Result: Memory 1 ranks higher and is returned correctly

### Technical Notes

1. **Hybrid Approach**: Both fixes maintain the system's hybrid approach - using semantic intelligence as the primary method with strategic keyword-aware boosting for disambiguation.

2. **Token Efficiency**: The ordinal boost is zero-token (deterministic pattern matching), keeping costs low.

3. **Integration**: The ordinal boost integrates seamlessly into the existing boost pipeline: Safety-Critical → Ordinal → Hybrid Scoring

4. **Logging**: Both fixes include comprehensive logging for debugging:
   - `[EMBEDDING-FALLBACK]` logs for token extraction
   - `[ORDINAL-BOOST]` logs for ordinal detection and boosting

### Expected Test Results

**T2 - Token Extraction**:
- Store: "Remember this exactly: ZEBRA-ANCHOR-123"
- Query: "What phrase did I ask you to remember?"
- Expected: ✅ Token extracted and retrieved correctly
- Result: `injected: 1+`, Response contains "ZEBRA-ANCHOR-123"

**T3 - Semantic Ranking**:
- Store: "My first code is CHARLIE-123"
- Store: "My second code is DELTA-456"
- Query: "What is my first code?"
- Expected: ✅ Returns "CHARLIE-123" (NOT DELTA)
- Query: "What is my second code?"
- Expected: ✅ Returns "DELTA-456" (NOT CHARLIE)

### Philosophy Alignment

These fixes align with CLAUDE.md principles:
- **Truth First**: Correctly retrieve the exact information the user stored
- **Helpful Second**: Solve the ordinal disambiguation problem without requiring the user to change their natural language
- **Complete**: Both issues resolved in a single, comprehensive fix
- **Efficient**: Zero additional API calls, minimal performance impact
- **Semantic Intelligence**: Uses genuine reasoning (ordinal matching) rather than just keyword arrays

---END SUMMARY---
