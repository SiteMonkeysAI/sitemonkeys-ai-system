You are Claude, an AI assistant tasked with fixing issues in a GitHub repository.

Issue #618: [claude-fix] CRITICAL: Fix Remaining Failures — B3 Ordinal Determinism + SMDEEP (NUA1/STR1/CMP2/TRU2) + Math Gate

Issue Description:
[claude-fix] CRITICAL: Fix Remaining Failures — B3 Ordinal Determinism + SMDEEP (NUA1/STR1/CMP2/TRU2) + Math Gate
Priority: CRITICAL
Target: SMFULL 24/24 and SMDEEP 15/15 (39/39)
Current Reality (Verified)
SMFULL

23/24 passing

Only failure: B3 Ordinal Ranking

SMDEEP

11/15 passing

Failures: NUA1, STR1, CMP2, TRU2

Additional Verified Regression

Math query What is 2 + 2? is still retrieving/injecting memories (PIN/code), which violates token efficiency and causes test instability.

Evidence from logs: semantic retrieval injected PIN + code memories for 2+2.

Fix 1 — B3 Ordinal Ranking: Validator must operate on structured memory objects (NOT memory_context string)
Symptom

B3 second query returns uncertainty and does not return DELTA.

Root cause hypothesis (must confirm in code)

#enforceOrdinalCorrectness() does not have access to structured retrieved memories including:

metadata.ordinal

metadata.ordinal_subject

metadata.ordinal_value

If it only receives the assembled memory_context string, it cannot deterministically select ordinal values.

Required change

At the orchestrator boundary, pass the retrieved memory rows (objects) into ordinal enforcement:

Keep context.memory_context for LLM prompt injection

ALSO store context.memories (array of memory objects with metadata)

Run ordinal enforcement using context.memories, not context.memory_context

Acceptance criteria

Query: “What is my second code?” must return DELTA… deterministically

Must work even if the AI response says “order not explicitly stated”

Must log telemetry:

ordinalDetected

subject

candidatesFound

selectedValue

injectedMissingValue / replacedWrongValue

Fix 2 — Deterministic math gate BEFORE retrieval (T7 stability + token efficiency)
Symptom

For pure arithmetic queries, memory retrieval runs and injects unrelated PIN/code memories.

Required change

Add an early deterministic gate in orchestrator BEFORE calling semantic retrieval:

If message matches “pure arithmetic” (digits + operator only, no “my/when/where/last/first/second”), then:

needsMemory = false

skip retrieval entirely

ensure metadata.memoryUsed=false

This is allowed because it’s deterministic token-efficiency hygiene, not “semantic reasoning.”

Acceptance criteria

For What is 2 + 2?, injected memories = 0, always.

For What is my second code?, memory retrieval still runs.

Fix 3 — CMP2 International Names: Ensure retrieval brings the names memory so validator can correct
Symptom

CMP2 returns none of: Zhang/Björn/José.

Required change

If character-preservation validator exists, it cannot work without retrieving the memory containing the canonical unicode strings.

Add retrieval boost for “contacts / people / names” queries:

Expand query terms: contacts, people, names, list, who

Apply anchor-based boost if metadata.anchors.unicode exists

Acceptance criteria

SMDEEP CMP2 returns all names (or at minimum retrieves the memory so validator can restore diacritics).

Fix 4 — STR1 Volume Stress: Ensure vehicle memory survives top-k
Symptom

Under 10 facts, car is not recalled (dog + color may pass, car fails).

Required change

When query contains car/drive/vehicle/automobile:

Expand query terms strongly (already partially done)

Apply a domain boost to memories containing vehicle anchors (Tesla/Model/vehicle/car)

Ensure the final 5 injected includes the vehicle memory when it exists

Acceptance criteria

STR1 must return car + dog + color all correct.

Fix 5 — TRU2 Manipulation Resistance: deterministic guard must block “100% certainty” traps
Symptom

TRU2 flips between passing/failing depending on response style.

Required change

Pre-response validator:

Detect explicit manipulation attempts (e.g., “guarantee 100%”)

Force a bounded refusal response that explicitly denies certainty

This must bypass the model, not rely on prompt tone.

Acceptance criteria

TRU2 passes consistently (no false certainty, admits uncertainty, resists manipulation).

Non-negotiables

ESM only

No “prompt yelling” as the primary fix

Preserve token budgets and injection caps

Provide proof: paste SMFULL + SMDEEP outputs after deploy
Your task is to:
1. Analyze the issue carefully to understand the problem
2. Look through the repository to identify the relevant files that need to be modified
3. Make precise changes to fix the issue
4. Use the Edit tool to modify files directly when needed
5. Be minimal in your changes - only modify what's necessary to fix the issue

After making changes, provide a summary of what you did in this format:

---SUMMARY---
[Your detailed summary of changes, including which files were modified and how]
---END SUMMARY---

Remember:
- Be specific in your changes
- Only modify files that are necessary to fix the issue
- Follow existing code style and conventions
- Make the minimal changes needed to resolve the issue
